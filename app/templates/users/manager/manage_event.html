{% extends "layouts/dashboard_base.html" %}


{% block page_title %}Manage: {{ event.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <div>
        <span class="badge bg-primary mb-1">{{ event.sport.name }}</span>
        <h5 class="text-muted mb-0"><i class="fas fa-map-marker-alt me-1"></i> {{ event.venue.name if event.venue else "TBD" }}</h5>
    </div>
    <a href="{{ url_for('users.manager_my_events') }}" class="btn btn-outline-secondary rounded-pill btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Back to List
    </a>
</div>

<ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active rounded-pill px-4" id="pills-teams-tab" data-bs-toggle="pill" data-bs-target="#pills-teams">
            <i class="fas fa-users me-2"></i>Teams & Players
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link rounded-pill px-4" id="pills-fixtures-tab" data-bs-toggle="pill" data-bs-target="#pills-fixtures">
            <i class="fas fa-calendar-alt me-2"></i>Fixtures
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link rounded-pill px-4" id="pills-settings-tab" data-bs-toggle="pill" data-bs-target="#pills-settings">
            <i class="fas fa-cogs me-2"></i>Settings
        </button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">
    
    <div class="tab-pane fade show active" id="pills-teams">
        <div class="row">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center py-3">
                        <h6 class="fw-bold mb-0">Registered Teams</h6>
                        <button class="btn btn-sm btn-primary rounded-circle shadow-sm" data-bs-toggle="modal" data-bs-target="#addTeamModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="list-group list-group-flush" id="teamList">
                        {% for team in teams %}
                        <a href="#" class="list-group-item list-group-item-action py-3 team-item" onclick="loadSquad({{ team.id }}, '{{ team.name }}')">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 fw-bold">{{ team.name }}</h6>
                                <small class="text-muted">{{ team.city }}</small>
                            </div>
                            <small class="text-primary"><i class="fas fa-user-tie me-1"></i> {{ team.coach_name }}</small>
                        </a>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <small>No teams added yet.</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100" id="squadPanel" style="display:none;">
                    <div class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-0" id="selectedTeamName">Select a Team</h5>
                            <small class="text-muted">Squad Management</small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm rounded-pill fw-bold" onclick="openAddPlayerModal()">
                            <i class="fas fa-user-plus me-1"></i> Add Player
                        </button>
                    </div>
                    <div class="card-body bg-light" id="squadListContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card border-0 shadow-sm h-100 d-flex align-items-center justify-content-center p-5" id="squadEmptyState">
                    <div class="text-center text-muted opacity-50">
                        <i class="fas fa-hand-point-left fa-3x mb-3"></i>
                        <h5>Select a team to manage players</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <div class="tab-pane fade" id="pills-fixtures">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-3">
                    <h6 class="fw-bold mb-0"><i class="fas fa-plus-circle me-2"></i>Schedule Match</h6>
                </div>
                <div class="card-body">
                    <form id="addFixtureForm">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Round / Phase</label>
                            <select name="round_name" class="form-select form-select-sm">
                                <option>Group Stage</option>
                                <option>Quarter-Final</option>
                                <option>Semi-Final</option>
                                <option>Final</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Date & Time</label>
                            <input type="datetime-local" name="start_time" class="form-control form-control-sm" required>
                        </div>

                        {% if event.sport.type == 'team' %}
                        <div class="mb-3 p-3 bg-light rounded border">
                            <label class="form-label small fw-bold text-primary mb-2">Matchup</label>
                            <select name="team_a" class="form-select form-select-sm mb-2" required>
                                <option value="" selected disabled>Select Home Team</option>
                                {% for team in teams %}
                                    <option value="{{ team.id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="text-center text-muted small fw-bold mb-2">VS</div>
                            <select name="team_b" class="form-select form-select-sm" required>
                                <option value="" selected disabled>Select Away Team</option>
                                {% for team in teams %}
                                    <option value="{{ team.id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="title" value="Match">
                        
                        {% else %}
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Session Title</label>
                            <input type="text" name="title" class="form-control" placeholder="e.g. Men's 85kg Group A" required>
                        </div>
                        {% endif %}

                        <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm fw-bold">
                            <i class="fas fa-calendar-check me-2"></i> Add to Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-bottom-0">
                    <h6 class="fw-bold mb-0">Upcoming Schedule</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted small text-uppercase">
                                <tr>
                                    <th class="ps-4">Date</th>
                                    <th>Match Details</th>
                                    <th>Round</th>
                                    <th class="text-end pe-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="fixtureTableBody">
                                {% for fixture in event.fixtures %}
                                <tr>
                                    <td class="ps-4 text-muted small">
                                        <div class="fw-bold text-dark">{{ fixture.start_time.strftime('%d %b') }}</div>
                                        {{ fixture.start_time.strftime('%I:%M %p') }}
                                    </td>
                                    <td>
                                        {% if event.sport.type == 'team' %}
                                            <div class="d-flex align-items-center">
                                                <span class="fw-bold">{{ fixture.team_a_obj.name }}</span> <span class="badge bg-secondary mx-2 small">VS</span>
                                                <span class="fw-bold">{{ fixture.team_b_obj.name }}</span>
                                            </div>
                                        {% else %}
                                            <span class="fw-bold text-primary">{{ fixture.title }}</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-light text-dark border">{{ fixture.round_name }}</span></td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-outline-primary rounded-pill px-3"

                                        >
<!--    onclick="openScoreModal({{ fixture.id }}, '{{ fixture.title }}')"-->
                                            Score <i class="fas fa-edit ms-1"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        <i class="far fa-calendar fa-2x mb-2 opacity-50"></i>
                                        <p>No matches scheduled yet.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="tab-pane fade" id="pills-settings">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-5">
                    <h5 class="fw-bold text-dark border-bottom pb-3 mb-4">Event Configuration</h5>
                    
                    <form action="{{ url_for('users.update_event_settings', event_id=event.id) }}" method="POST">
                        <div class="row g-4">
                            <div class="col-md-12">
                                <label class="form-label fw-bold text-muted small text-uppercase">Current Status</label>
                                <div class="d-flex gap-2">
                                    <input type="radio" class="btn-check" name="status" id="status1" value="upcoming" {{ 'checked' if event.status == 'upcoming' }}>
                                    <label class="btn btn-outline-primary px-4 rounded-pill" for="status1">Upcoming</label>

                                    <input type="radio" class="btn-check" name="status" id="status2" value="live" {{ 'checked' if event.status == 'live' }} >
                                    <label class="btn btn-outline-danger px-4 rounded-pill" for="status2">Live Now</label>

                                    <input type="radio" class="btn-check" name="status" id="status3" value="completed" {{ 'checked' if event.status == 'completed' }}>
                                    <label class="btn btn-outline-secondary px-4 rounded-pill" for="status3">Completed</label>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold small text-muted">Event Title</label>
                                <input type="text" name="title" class="form-control" value="{{ event.title }}">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold small text-muted">Description</label>
                                <textarea name="description" class="form-control" rows="4">{{ event.description }}</textarea>
                            </div>
                        </div>

                        <div class="mt-5 d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-danger border-0">
                                <i class="fas fa-trash-alt me-2"></i> Delete Event
                            </button>
                            <button type="submit" class="btn btn-success rounded-pill px-5 fw-bold shadow">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<div class="modal fade" id="addTeamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Add New Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTeamForm">
                    <div class="mb-3">
                        <label class="form-label">Team Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">City / Base</label>
                            <input type="text" name="city" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Coach Name</label>
                            <input type="text" name="coach_name" class="form-control" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Save Team</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Add Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPlayerForm">
                    <input type="hidden" id="currentTeamId">
                    
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="playerName" class="form-control" required>
                    </div>

                    <hr class="opacity-25 my-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Sport Specifics</h6>
                    
                    <div id="dynamicPlayerFields" class="row g-2">
                        </div>

                    <div class="mt-4">
                        <button type="button" class="btn btn-success w-100 rounded-pill" onclick="submitPlayer()">
                            Add to Squad
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="scoreModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="scoreModalTitle">Score Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <form id="scoreForm">
                    <input type="hidden" id="scoreFixtureId" name="fixture_id">

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped text-center align-middle mb-0">
                            <thead class="bg-white">
                                <tr>
                                    <th rowspan="2" class="align-middle">Player</th>
                                    <th colspan="3" class="text-primary border-bottom-0">Snatch (kg)</th>
                                    <th colspan="3" class="text-danger border-bottom-0">Clean & Jerk (kg)</th>
                                    <th rowspan="2" class="align-middle bg-light">Total</th>
                                </tr>
                                <tr>
                                    <th class="text-primary"><small>1</small></th>
                                    <th class="text-primary"><small>2</small></th>
                                    <th class="text-primary"><small>3</small></th>
                                    <th class="text-danger"><small>1</small></th>
                                    <th class="text-danger"><small>2</small></th>
                                    <th class="text-danger"><small>3</small></th>
                                </tr>
                            </thead>
                            <tbody id="scoreTableBody">
                                </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary px-4 fw-bold" onclick="submitScores()">Save Results</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. GLOBAL VARIABLES
    // Ensure sport_schema is safely parsed. If None, default to empty object.
    const SPORT_SCHEMA = {{ sport_schema|tojson|default('{}') }};
    let activeTeamId = null;

    $(document).ready(function() {
        
        // ------------------------------------------
        // A. TEAM FORM SUBMISSION
        // ------------------------------------------
        $('#addTeamForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                url: "/users/api/event/{{ event.id }}/add_team",
                type: "POST",
                data: $(this).serialize(),
                success: function(resp) {
                    location.reload(); 
                },
                error: function(err) {
                    alert('Error adding team. Please try again.');
                }
            });
        });

        // ------------------------------------------
        // B. FIXTURE FORM SUBMISSION
        // ------------------------------------------
        $('#addFixtureForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                url: "/users/api/event/{{ event.id }}/add_fixture",
                type: "POST",
                data: $(this).serialize(),
                success: function(resp) {
                    location.reload(); 
                },
                error: function(err) {
                    // Safe error handling if responseJSON is missing
                    let msg = (err.responseJSON && err.responseJSON.message) ? err.responseJSON.message : "Unknown Error";
                    alert("Error scheduling match: " + msg);
                }
            });
        });

    }); // End of document.ready

    // ------------------------------------------
    // C. SQUAD LOADER (Standalone Function)
    // ------------------------------------------
    function loadSquad(teamId, teamName) {
        activeTeamId = teamId;
        
        // UI Updates
        $('#squadEmptyState').hide();
        $('#squadPanel').show();
        $('#selectedTeamName').text(teamName);
        $('#currentTeamId').val(teamId);
        
        // Show Loading Spinner
        $('#squadListContainer').html('<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>');

        // Fetch Players
        $.ajax({
            url: "/users/api/team/" + teamId + "/get_players",
            success: function(resp) {
                $('#squadListContainer').html(resp.html);
            }
        });
    }

    // ------------------------------------------
    // D. DYNAMIC PLAYER MODAL (Standalone Function)
    // ------------------------------------------
    function openAddPlayerModal() {
        if(!activeTeamId) {
            alert("Please select a team first.");
            return;
        }

        let container = $('#dynamicPlayerFields');
        container.empty();

        // 1. Check for Roles in Schema
        if(SPORT_SCHEMA.roles && SPORT_SCHEMA.roles.length > 0) {
            let options = SPORT_SCHEMA.roles.map(r => `<option>${r}</option>`).join('');
            container.append(`
                <div class="col-12 mb-2">
                    <label class="form-label small">Role / Position</label>
                    <select class="form-select" id="field_role">${options}</select>
                </div>
            `);
        }

        // 2. Check for Specific Fields based on Sport Logic
        // CRICKET
        if(SPORT_SCHEMA.scoring_unit && SPORT_SCHEMA.scoring_unit.includes('wickets')) {
            container.append(`
                <div class="col-6 mb-2">
                    <label class="form-label small">Batting Style</label>
                    <select class="form-select" id="field_batting_style">
                        <option>Right Hand</option><option>Left Hand</option>
                    </select>
                </div>
                <div class="col-6 mb-2">
                    <label class="form-label small">Bowling Style</label>
                    <select class="form-select" id="field_bowling_style">
                        <option>None</option><option>Right Pace</option><option>Right Spin</option>
                    </select>
                </div>
            `);
        } 
        // WEIGHTLIFTING
        else if(SPORT_SCHEMA.categories) {
            let cats = SPORT_SCHEMA.categories.map(c => `<option>${c}</option>`).join('');
            container.append(`
                <div class="col-6 mb-2">
                    <label class="form-label small">Weight Category</label>
                    <select class="form-select" id="field_weight_class">${cats}</select>
                </div>
                <div class="col-6 mb-2">
                    <label class="form-label small">Body Weight (kg)</label>
                    <input type="number" step="0.1" class="form-control" id="field_body_weight">
                </div>
            `);
        } 
        // GENERIC FALLBACK
        else {
             container.append(`
                <div class="col-12 mb-2">
                    <label class="form-label small">Jersey Number</label>
                    <input type="number" class="form-control" id="field_jersey">
                </div>
            `);
        }

        $('#addPlayerModal').modal('show');
    }

    // ------------------------------------------
    // E. SUBMIT PLAYER (Standalone Function)
    // ------------------------------------------
    function submitPlayer() {
        // Collect Basic Data
        let payload = {
            name: $('#playerName').val()
        };

        if(!payload.name) {
            alert("Player name is required");
            return;
        }

        // Collect Dynamic Inputs (ids start with 'field_')
        $('[id^="field_"]').each(function() {
            let key = $(this).attr('id').replace('field_', '');
            payload[key] = $(this).val();
        });

        // AJAX Post
        $.ajax({
            url: "/users/api/team/" + activeTeamId + "/add_player",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function(resp) {
                $('#addPlayerModal').modal('hide');
                loadSquad(activeTeamId, $('#selectedTeamName').text()); // Refresh List
                $('#playerName').val(''); // Reset Name Input
            },
            error: function(err) {
                alert("Error adding player: " + (err.responseJSON ? err.responseJSON.message : "Unknown error"));
            }
        });
    }
    // OPEN MODAL & LOAD PLAYERS
function openScoreModal(fixtureId, title) {
    $('#scoreModalTitle').text("Scoring: " + title);
    $('#scoreFixtureId').val(fixtureId);
    $('#scoreTableBody').html('<tr><td colspan="9" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>');

    // Fetch players and existing scores
    $.ajax({
        url: `/users/api/fixture/${fixtureId}/get_scores`,
        success: function(resp) {
            let html = '';
            if(resp.players.length === 0) {
                 html = '<tr><td colspan="9" class="text-center py-4 text-muted">No players found in this event. Add teams/players first.</td></tr>';
            } else {
                resp.players.forEach(p => {
                    // p.scores is an object like {s1: 100, s2: 105...}
                    let s = p.scores || {};
                    let weightClass = (p.details && p.details.weight_class) ? p.details.weight_class : '-';

                    html += `
                    <tr>
                        <td class="text-start ps-3">
                            <div class="fw-bold">${p.name}</div>
                            <div class="small text-muted">${p.team_name} â€¢ ${weightClass}</div>
                        </td>

                        <td><input type="number" class="form-control form-control-sm text-center" name="p_${p.id}_s1" value="${s.s1 || ''}" placeholder="-"></td>
                        <td><input type="number" class="form-control form-control-sm text-center" name="p_${p.id}_s2" value="${s.s2 || ''}" placeholder="-"></td>
                        <td><input type="number" class="form-control form-control-sm text-center" name="p_${p.id}_s3" value="${s.s3 || ''}" placeholder="-"></td>

                        <td><input type="number" class="form-control form-control-sm text-center" name="p_${p.id}_c1" value="${s.c1 || ''}" placeholder="-"></td>
                        <td><input type="number" class="form-control form-control-sm text-center" name="p_${p.id}_c2" value="${s.c2 || ''}" placeholder="-"></td>
                        <td><input type="number" class="form-control form-control-sm text-center" name="p_${p.id}_c3" value="${s.c3 || ''}" placeholder="-"></td>

                        <td class="fw-bold fs-5 bg-light">${s.total || 0}</td>
                    </tr>`;
                });
            }
            $('#scoreTableBody').html(html);
            $('#scoreModal').modal('show');
        }
    });
}

// SUBMIT SCORES
function submitScores() {
    $.ajax({
        url: "/users/api/save_scores",
        type: "POST",
        data: $('#scoreForm').serialize(),
        success: function(resp) {
            alert(resp.message);
            $('#scoreModal').modal('hide');
        },
        error: function(err) {
            alert("Error saving scores");
        }
    });
}
    // DELETE PLAYER FUNCTION
function deletePlayer(playerId) {
    if(!confirm("Are you sure you want to remove this player from the squad?")) {
        return;
    }

    $.ajax({
        url: `/users/api/player/${playerId}/delete`,
        type: "POST",
        success: function(resp) {
            // Refresh the squad list to show the player is gone
            loadSquad(activeTeamId, $('#selectedTeamName').text());
        },
        error: function(err) {
            alert("Error removing player: " + (err.responseJSON ? err.responseJSON.message : "Unknown error"));
        }
    });
}
</script>
{% endblock %}
{% extends "layouts/dashboard_base.html" %}

{% block page_title %}Event Management{% endblock %}

{% block content %}

<div class="row align-items-center justify-content-center" style="min-height: 60vh;">
    <div class="col-md-8 text-center">
        <div class="mb-4">
            <img src="https://cdn-icons-png.flaticon.com/512/7604/7604060.png" width="120" alt="Create Icon" class="opacity-75">
        </div>
        <h2 class="fw-bold text-dark">Ready to Host?</h2>
        <p class="text-muted mb-4 lead">Configure rules, set squad limits, and launch your tournament in minutes.</p>
        
        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#modalStep1">
            <i class="fas fa-plus-circle me-2"></i> Create New Event
        </button>
    </div>
</div>

<div class="modal fade" id="modalStep1" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title fw-bold text-primary">Step 1: The Basics</h5>
                    <p class="text-muted small mb-0">Define the core details of the event.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="formStep1">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="inpTitle" placeholder="Title" required>
                                <label>Tournament Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="inpSport" required>
                                    <option value="" selected disabled>Select...</option>
                                    {% for sport in sports %}
                                        <option value="{{ sport.id }}" data-name="{{ sport.name }}">{{ sport.name }}</option>
                                    {% endfor %}
                                </select>
                                <label>Sport</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="inpVenue">
                                    <option value="">To Be Decided</option>
                                    {% for venue in venues %}
                                        <option value="{{ venue.id }}">{{ venue.name }}</option>
                                    {% endfor %}
                                </select>
                                <label>Venue</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="inpDate" required>
                                <label>Start Date</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <textarea class="form-control" id="inpDesc" placeholder="Desc" style="height: 80px"></textarea>
                                <label>Description (Optional)</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="goToStep2()">Next <i class="fas fa-arrow-right ms-1"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalStep2" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title fw-bold text-primary">Step 2: Configuration</h5>
                    <p class="text-muted small mb-0">Set squad limits and sport specifics.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <h6 class="fw-bold text-dark border-bottom pb-2 mb-3"><i class="fas fa-users-cog me-2"></i>Participation Details</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="small fw-bold text-muted">Max Teams / Participants</label>
                        <input type="number" class="form-control" id="inpMaxTeams" value="8">
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold text-muted">Squad Size (Max Players)</label>
                        <input type="number" class="form-control" id="inpSquadSize" value="15">
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold text-muted">Min Players Required</label>
                        <input type="number" class="form-control" id="inpMinPlayers" value="11">
                    </div>
                </div>

                <h6 class="fw-bold text-dark border-bottom pb-2 mb-3"><i class="fas fa-basketball-ball me-2"></i>Game Rules</h6>
                <div id="sportSpecificContainer" class="row g-3">
                    </div>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-target="#modalStep1" data-bs-toggle="modal">Back</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="goToStep3()">Next <i class="fas fa-arrow-right ms-1"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalStep3" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title fw-bold text-primary">Step 3: Custom Rules</h5>
                    <p class="text-muted small mb-0">Add specific regulations for this tournament.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4 bg-light">
                <div class="row mb-2 px-2 d-none d-md-flex text-muted small fw-bold text-uppercase">
                    <div class="col-3">Rule Label</div>
                    <div class="col-3">Value / Constraint</div>
                    <div class="col-5">Description (Optional)</div>
                    <div class="col-1"></div>
                </div>

                <div id="customRulesList" class="vstack gap-2">
                    </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-outline-primary rounded-pill border-2 fw-bold px-4" onclick="addCustomRuleRow()">
                        <i class="fas fa-plus me-1"></i> Add Custom Rule
                    </button>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-target="#modalStep2" data-bs-toggle="modal">Back</button>
                <button type="button" class="btn btn-success rounded-pill px-5 shadow fw-bold" onclick="submitTournament()">
                    Launch Tournament <i class="fas fa-rocket ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060" id="toastArea"></div>

{% endblock %}

{% block scripts %}
<script>
    // GLOBAL STATE
    var formData = {};

    // 1. NAVIGATE TO STEP 2
    function goToStep2() {
        // Validation Step 1
        var title = $('#inpTitle').val();
        var sport = $('#inpSport').val();
        var date = $('#inpDate').val();

        if(!title || !sport || !date) {
            showToast('danger', 'Please fill in Title, Sport and Date.');
            return;
        }

        // Save Data
        formData.title = title;
        formData.sport_id = sport;
        formData.venue_id = $('#inpVenue').val();
        formData.start_date = date;
        formData.description = $('#inpDesc').val();

        // Load Sport Specifics
        var sportName = $('#inpSport option:selected').data('name');
        loadSportInputs(sportName);

        // Switch Modals
        $('#modalStep1').modal('hide');
        $('#modalStep2').modal('show');
    }

    // 2. NAVIGATE TO STEP 3
    function goToStep3() {
        // Save Step 2 Data
        formData.team_config = {
            max_teams: $('#inpMaxTeams').val(),
            squad_size: $('#inpSquadSize').val(),
            min_players: $('#inpMinPlayers').val()
        };

        // Collect Standard Rules from generated inputs
        var standardRules = {};
        $('#sportSpecificContainer input, #sportSpecificContainer select').each(function() {
            var label = $(this).prev('label').text();
            standardRules[label] = $(this).val();
        });
        formData.standard_rules = standardRules;

        // Switch Modals
        $('#modalStep2').modal('hide');
        $('#modalStep3').modal('show');
    }

    // 3. LOAD SPORT INPUTS (Step 2 Logic)
    function loadSportInputs(sportName) {
        var container = $('#sportSpecificContainer');
        container.empty();

        if(sportName === 'Cricket') {
            container.append(createInput('Overs Per Innings', 'number', 20));
            container.append(createSelect('Ball Type', ['Red Leather', 'White Leather', 'Tennis']));
            container.append(createSelect('Format', ['T20', 'ODI', 'Test']));
        } else if(sportName === 'Football') {
            container.append(createInput('Half Duration (mins)', 'number', 45));
            container.append(createInput('Substitutions Allowed', 'number', 5));
        } else if(sportName === 'Kabaddi') {
            container.append(createInput('Match Duration (mins)', 'number', 40));
            container.append(createInput('Weight Limit (kg)', 'number', 85));
        } else if(sportName === 'Weightlifting') {
            container.append(createInput('Attempts Per Lift', 'number', 3));
            container.append(createSelect('Scoring', ['Total Weight', 'Sinclair']));
        }
    }

    // Helper to create inputs
    function createInput(label, type, val) {
        return `<div class="col-md-6">
                    <label class="small fw-bold text-muted">${label}</label>
                    <input type="${type}" class="form-control" value="${val}">
                </div>`;
    }
    function createSelect(label, options) {
        let opts = options.map(o => `<option>${o}</option>`).join('');
        return `<div class="col-md-6">
                    <label class="small fw-bold text-muted">${label}</label>
                    <select class="form-select">${opts}</select>
                </div>`;
    }

    // 4. CUSTOM RULES LOGIC (Step 3)
    function addCustomRuleRow() {
        var rowId = Date.now();
        var html = `
            <div class="row g-2 align-items-center bg-white p-2 rounded shadow-sm border mb-2 rule-row" id="rule-${rowId}">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm fw-bold" placeholder="Label (e.g. Dress Code)" required>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" placeholder="Value (e.g. Whites Only)" required>
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm text-muted" placeholder="Description / Note">
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="$('#rule-${rowId}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        $('#customRulesList').append(html);
    }

    // 5. FINAL SUBMISSION
    function submitTournament() {
        // Collect Custom Rules
        var customRules = [];
        $('.rule-row').each(function() {
            var inputs = $(this).find('input');
            var label = inputs.eq(0).val();
            var value = inputs.eq(1).val();
            var desc = inputs.eq(2).val();
            
            if(label && value) {
                customRules.push({ label: label, value: value, desc: desc });
            }
        });
        formData.custom_rules = customRules;

        // AJAX POST
        $.ajax({
            url: "{{ url_for('users.create_event') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function(response) {
                if(response.status === 'success') {
                    showToast('success', response.message);
                    setTimeout(function() {
                        window.location.href = response.redirect_url;
                    }, 1500);
                } else {
                    showToast('danger', response.message);
                }
            },
            error: function(err) {
                showToast('danger', 'Server Error: ' + err.statusText);
            }
        });
    }

    // 6. TOAST HELPER (Bootstrap 5)
    function showToast(type, msg) {
        var icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
        var html = `
            <div class="toast align-items-center text-white bg-${type} border-0 shadow-lg show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${icon} me-2"></i> ${msg}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        $('#toastArea').append(html);
        
        // Auto remove after 3s
        setTimeout(() => { $('.toast').last().remove(); }, 4000);
    }
</script>
{% endblock %}